### 管道

管道分为两种类型：数值转换、数值验证：

- 数值转换：将输入数据转换为期望的形式（例如，从字符串转换为整数）
- 数值验证：评估输入数据，如果有效，则原样通过；否则，抛出异常

### 创建数值转换管道

数值转换管道使用 **Injectable** 装饰器，继承 **PipeTransform** 类，接收 **transform** 构造函数

```ts
import { ArgumentMetadata, Injectable, PipeTransform } from '@nestjs/common';

@Injectable()
export class IdPipe implements PipeTransform {
  transform(value: any, metadata: ArgumentMetadata) {
    console.log('metadata', metadata);
    return value + '值已被管道处理转换';
  }
}

```

**metadata** 元数据，包含value的一些数据信息，包含以下属性：

```ts
export interface ArgumentMetadata {
  type: 'body' | 'query' | 'param' | 'custom';
  metatype?: Type<unknown>;
  data?: string;
}
```

#### 数值管道使用

数值管道在**参数装饰器**中使用，用于转换指定的参数值：

```ts
import { Controller, Get, Param } from '@nestjs/common';
import { IdPipe } from '../id/id.pipe';

@Controller('home')
export class HomeController {
  constructor(private readonly homeService: HomeService) {}

  @Get(':id')
  getData(@Param('id', IdPipe) id: string) {
    return this.homeService.getIdData(id);
  }

}
```

#### 内置验证管道

- ValidationPipe: 对指定字段进行验证

- ParseIntPipe
- ParseFloatPipe
- ParseBoolPipe
- ParseArrayPipe
- ParseUUIDPipe
- ParseEnumPipe
- DefaultValuePipe
- ParseFilePipe
- ParseDatePipe



### 内置验证管道的使用

#### ValidationPipe使用

**ValidationPipe** 用来对数据类型的验证，要使用该内置管道验证需要下载以下依赖：

```bash
npm i --save class-validator class-transformer
```

**class-validator** 用来创建验证规则，如：

```ts 
import { IsEmail, IsNotEmpty } from 'class-validator';
export class ParamsDataDto {
  @IsEmail(
    {},
    {
      message: '邮箱格式不正确',
    },
  )
  email: string;
  @IsNotEmpty({ message: '密码不能为空' })
  password: string;
}
```

在控制器中使用该规则同时使用ValidationPipe管道：

```ts
import {
  Controller,
  Get,
  Param,
  ValidationPipe,
  UsePipes,
} from '@nestjs/common';
import { ValidateService } from './validate.service';
import { ParamsDataDto } from './valudate.dto';

@Controller('validate')
@UsePipes(ValidationPipe) // 使用内置管道验证
export class ValidateController {
  constructor(private readonly validateService: ValidateService) {}

  @Get()
  getData(@Param() params: ParamsDataDto) { // 使用创建的 class-validator 验证规则
    this.validateService.get(params);
  }
}
```

ValidationPipe 会去验证 参数 params 中的 emial 字段是否为邮箱格式，以及 password 字段是否为空；

验证规则我们以 **Dto** 结尾

> 对于 **class-validator** 的使用可以参考：[class-validator文档](https://github.com/typestack/class-validator)

#### 实例

验证请求参数 id 是否为 string:

使用验证管道及验证规则

```ts
// controller.ts
import {
  Controller,
  Get,
  Param,
  ValidationPipe,
  UsePipes,
} from '@nestjs/common';
import { ValidateService } from './validate.service';
import { ParamsDataDto } from './valudate.dto';

@Controller('validate')
@UsePipes(ValidationPipe) // 使用 ValidationPipe 内置管道
export class ValidateController {
  constructor(private readonly validateService: ValidateService) {}

  @Get(':id')
  getData(@Param() params: ParamsDataDto) { // 使用 ParamsDataDto 验证队规则验证参数 params
    return this.validateService.get(params);
  }
}

```

创建验证规则:

```ts
import { IsString } from 'class-validator';
export class ParamsDataDto {
  @IsString({ message: 'id必须是字符串' })
  id: number;
}
```



