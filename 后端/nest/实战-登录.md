### å¯†ç éªŒè¯

ä½¿ç”¨ä»¥ä¸‹å·¥å…·:

- @nestjs/passport
- passport
- passport-local

passport æ˜¯ä¸€ä¸ªèº«ä»½éªŒè¯å·¥å…·ï¼Œæä¾›å¤šç§æ–¹å¼ï¼ˆç­–ç•¥ï¼‰çš„èº«ä»½è®¤è¯ï¼Œå…¶ä¸­ passport-local æ˜¯ä½¿ç”¨ç”¨æˆ·åä¸å¯†ç éªŒè¯ï¼›

@nestjs/passport æ˜¯ nestjs å°è£…çš„ passport



#### åˆ›å»º local ç­–ç•¥

```ts
import { Strategy } from 'passport-local';
import { PassportStrategy } from '@nestjs/passport';
import { Injectable } from '@nestjs/common';
import { AuthService } from '@/auth/auth.service';

@Injectable()
export class LocalStrategy extends PassportStrategy(Strategyï¼Œ[Strategy-name]) {
  constructor(private authService: AuthService) {
    // Strategyé…ç½®
    super({
      usernameField: 'username',
      passwordField: 'password',
    });
  }

  async validate(username: string, password: string): Promise<any> {
    const user = await this.authService.validateUser(username, password);
    return user;
  }
}

```

LocalStrategy ç»§æ‰¿è‡ª PassportStrategy, Strategy å¼•å…¥è‡ª passport-localï¼Œè¡¨æ˜ä½¿ç”¨ local ç­–ç•¥ï¼›

LocalStrategy ä¼šè‡ªåŠ¨å– username, password å­—æ®µï¼Œä¹Ÿå¯ä»¥åœ¨ super ä¸­é…ç½®å–çš„å­—æ®µåç§°ï¼›

validate å‡½æ•°ç”¨æ¥ç¼–å†™éªŒè¯é€»è¾‘ï¼Œreturn nullæˆ–è€… falseè¡¨åéªŒè¯å¤±è´¥ï¼ŒLocalStrategyä¼šæŠ›å‡º401é”™è¯¯ï¼›

[Strategy-name] ä¸ºå¯é€‰ä»£è¡¨ç­–ç•¥åç§°ï¼Œä¸å¡«å…¥æ—¶ä¸ºé»˜è®¤ local

æ¥ä¸‹æ¥åˆ›å»º validateUser å‡½æ•°ç”¨æ¥éªŒè¯èº«ä»½ï¼š

```ts
 async validateUser(
    username: string,
    password: string,
  ): Promise<Record<string, any> | null> {
    const user = await this.userService.findOneUser(username);
    if (user && (await argon2.verify(user.password, password))) return user;
    return null;
  }
```

#### æ³¨å†Œ passport

åœ¨ auth.module ä¸­æ³¨å†Œ passport:

```ts
import { Module } from '@nestjs/common';
import { UserModule } from 'src/user/user.module';
import { AuthController } from './auth.controller';
import { AuthService } from './auth.service';
import { PassportModule } from '@nestjs/passport';
import { LocalStrategy } from '@/strategy/local.strategy';

@Module({
  imports: [
    UserModule,
    PassportModule,
  ],
  controllers: [AuthController],
  providers: [AuthService, LocalStrategy],
})
export class AuthModule {}

```

å¼•å…¥ PassportModule æ—¶ï¼Œnextjs ä¼šå°†è¯¥ç­–ç•¥æ³¨å†Œè‡³å…¨å±€ï¼Œä¹Ÿå°±æ˜¯è¯´åé¢ä½¿ç”¨ LocalStrategy æ—¶å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼›

providers å°† LocalStrategy å¯¼å‡ºï¼›

éœ€è¦æ³¨å†Œå¤šä¸ªStrategyæ—¶éœ€è¦è¿›è¡ŒåŒºåˆ†ï¼š

```ts
import { Injectable } from '@nestjs/common';
import { AuthGuard } from '@nestjs/passport';

@Injectable()
export class LocalAuthGuard extends AuthGuard([Strategy-name]) {}
```

#### ä½¿ç”¨

```ts
  @UseGuards(AuthGuard('local')) // æˆ–è€… @UseGuards(LocalAuthGuard)
  @Post('login')
  login(@Request() req: { user: UserDto }) {
    return req.user;
  }
```



### jwt ç”Ÿæˆ

åœ¨ auth.service ä¸­ä½¿ç”¨ @nestjs/jwt ä¸­çš„ JwtService ç”Ÿæˆtoken

```ts
  // ç”Ÿæˆtoken
  async createJWT(user: { username: string; id: string }): Promise<string> {
    const payload = { username: user.username, sub: user.id };
    const token = await this.jwtService.signAsync(payload);
    return token;
  }
```

å½“ç„¶ï¼Œå‰ææ—¶éœ€è¦æ³¨å†Œ jwtModule

```ts
auth.module.ts

@Module({
    JwtModule.registerAsync({
      global: true,
      useFactory: () => ({
        secret: process.env[configEnum.JWT_SECRET],
        signOptions: { expiresIn: process.env[configEnum.JWT_EXPIRES_IN] },
      }),
    }),
})
```

ä¹‹åå† user.controller.ts ä½¿ç”¨createJWTå¹¶è¿”å›token

```ts
 @UseGuards(AuthGuard('local'))
  @Post('login')
  @HttpCode(200)
  async login(@Request() req: { user: UserDto }) {
    const token = await this.authService.createJWT(req.user as any);
    return {
      data: {
        token,
        user: req.user,
      },
    };
  }
```

> **æ³¨æ„**
>
> **åœ¨ä¸¤ä¸ªæ¨¡å—ç›¸äº’å¼•ç”¨æ—¶ï¼Œä¼šå‡ºç°å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨ forwardRef()  å»¶è¿ŸåŠ è½½æ¨¡å— è§£å†³æ­¤é—®é¢˜**



### passport é»˜è®¤è¡Œä¸ºä¿®æ”¹

#### ä¿®æ”¹é»˜è®¤è¿”å›çš„é”™è¯¯ä¿¡æ¯

Passport ç­–ç•¥æä¾›äº† `handleRequest` æ–¹æ³•ï¼Œå¯ä»¥æ‹¦æˆªéªŒè¯é”™è¯¯å¹¶è‡ªå®šä¹‰å“åº”ï¼š

```ts
import { ExtractJwt, Strategy } from 'passport-jwt';
import { PassportStrategy } from '@nestjs/passport';
import { Injectable, UnauthorizedException } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';

@Injectable()
export class JwtStrategy extends PassportStrategy(Strategy) {
  constructor(private readonly configService: ConfigService) {
    super({
      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
      ignoreExpiration: false,
      secretOrKey: configService.get('JWT_SECRET'),
    });
  }

  // è¦†ç›– handleRequest æ–¹æ³•
  handleRequest(err: any, user: any, info: any, context: any, status: any) {
    if (err || !user) {
      throw new UnauthorizedException('æ— æ•ˆçš„ Token æˆ– Token å·²è¿‡æœŸ'); // è‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯
    }
    return user;
  }

  validate(payload: any) {
    return { userId: payload.sub, username: payload.username };
  }
}
```



#### ä¿®æ”¹ validate å‡½æ•°è¿”å›æ•°æ®çš„å­˜å‚¨å­—æ®µ

Passport ç­–ç•¥æä¾›äº† `authenticate ` æ–¹æ³•ï¼Œå¯ä»¥ä¿®æ”¹æ•°æ®å­˜å‚¨çš„ä½ç½®ï¼š

```ts
import { Strategy } from 'passport-jwt';
import { PassportStrategy } from '@nestjs/passport';
import { Injectable } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';

@Injectable()
export class JwtStrategy extends PassportStrategy(Strategy) {
  constructor(private readonly configService: ConfigService) {
    super({
      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
      secretOrKey: configService.get('JWT_SECRET'),
    });
  }

  // è¦†ç›– authenticate æ–¹æ³•ï¼Œä¿®æ”¹æ•°æ®å­˜å‚¨å­—æ®µ
  authenticate(req: any, options?: any) {
    super.authenticate(req, options, (err, user, info) => {
      if (err) return this.error(err);
      if (!user) return this.fail(info);
      
      // å°†æ•°æ®å­˜å‚¨åˆ° req.data è€Œé req.user
      req.data = user; // ğŸ¯ å…³é”®ä¿®æ”¹
      this.success(user, info);
    });
  }

  validate(payload: any) {
    return { id: payload.sub, username: payload.username }; // è¿”å›çš„æ•°æ®ä¼šå­˜å…¥ req.data
  }
}
```

æˆ–è€…ï¼šé€šè¿‡ç»§æ‰¿ `AuthGuard` å¹¶è¦†ç›–è¯·æ±‚å¤„ç†é€»è¾‘

```ts
// src/guards/jwt-auth.guard.ts
import { AuthGuard } from '@nestjs/passport';
import { Injectable } from '@nestjs/common';

@Injectable()
export class JwtAuthGuard extends AuthGuard('jwt') {
  handleRequest(err: any, user: any, info: any, context: any) {
    const request = context.switchToHttp().getRequest();
    request.data = user; // ğŸ¯ å°†æ•°æ®å­˜å…¥ req.data
    return user;
  }
}

// åœ¨ Controller ä¸­ä½¿ç”¨
@UseGuards(JwtAuthGuard)
@Get('profile')
getProfile(@Request() req) {
  return req.data; // æ•°æ®ç°åœ¨åœ¨ req.data ä¸­
}
```

