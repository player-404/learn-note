[nest日志](https://docs.nestjs.com/techniques/logger#logger)

### 日志配置与使用

日志可以在create中使用 logger 选项进行配置, 默认为true;

logger配置选项可为：log、fatal、error、warn、debug、verbose

```ts
NestFactory.create(AppModule, {
    // 日志配置
    logger: ['error', 'warn'],
  });
```

需要打印日志可以使用 `logger`方法进行打印:

```ts
import {Logger} from '@nestjs/common';
 Logger.warn(`服务启动成功，端口号：${process.env.PORT ?? 3000}`);
```

 要对输出log配置可以使用`ConsoleLogger`选项

### winston

winston为三方日志记录工具。下面介绍使用方法

- 下载 winston 和 nest-winston 包

```shell
npm i winston nest-winston -S
```

- main.js配置 winston

```ts
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import * as winston from 'winston';
import {
  WinstonModule,
  utilities as nestWinstonModuleUtilities,
} from 'nest-winston';
async function bootstrap() {
   // 创建 winston 实例
  const logger = winston.createLogger({
    transports: [
      new winston.transports.Console({
        format: winston.format.combine(
          winston.format.timestamp(),
          nestWinstonModuleUtilities.format.nestLike(),
        ),
      }),
    ],
  });
  const app = await NestFactory.create(AppModule, {
     // 将winston替换为默认的logger
    logger: WinstonModule.createLogger({
      instance: logger,
    }),
  });
  await app.listen(process.env.PORT ?? 3000);
}
bootstrap();

```

- 使用

```ts
module.ts

import { Module, Logger } from '@nestjs/common';

@Module({
  imports: [
    MongooseModule.forFeature([{ name: USER_MODEL, schema: userSchema }]),
  ],
  controllers: [UserController],
  providers: [UserService, Logger], // 注册logger
  exports: [UserService],
})
```

```ts
controller.ts

import { Controller, Post, Body, Get, Logger } from '@nestjs/common';

@Controller('user')
export class UserController {
  constructor(
    private readonly logger: Logger, // 注册 logger
  ) {}


  @Get()
  async getAllUsers() {
    this.logger.log('getAllUsers'); // 使用 logger
    ...
  }
}
```

- 保存日志到文件
  - 下载 `winston-daily-rotate-file` 依赖并添加如下配置

```ts
main.ts

import 'winston-daily-rotate-file';
async function bootstrap() {
  // 创建winston实例
  const logger = winston.createLogger({
    transports: [
      new winston.transports.Console({
        format: winston.format.combine(
          winston.format.timestamp(),
          nestWinstonModuleUtilities.format.nestLike(),
        ),
      }),
      // 记录日志到文件
      new winston.transports.DailyRotateFile({
        // 保存日志文件的目录
        dirname: 'logs',
        filename: 'logs/application-%DATE%.log',
        datePattern: 'YYYY-MM-DD',
        zippedArchive: true,
        maxSize: '20m', // 文件最大20M
        maxFiles: '14d', // 最多保存14天
        format: winston.format.combine(
         winston.format.timestamp(),
         winston.format.simple(),
        ),
      }),
    ],
  });
```

**参考文档:**

[nest-winston 文档](https://www.npmjs.com/package/nest-winston)

[winston 文档](https://github.com/winstonjs/winston)

[winston-daily-rotate-file 文档](https://www.npmjs.com/package/winston-daily-rotate-file)